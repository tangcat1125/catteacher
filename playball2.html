<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ²™ç˜æ’çƒéŠæˆ²</title>
  <style>
    body { background: #ffe4b5; }
    canvas { background: #ffe4b5; display: block; margin: 0 auto; border: 2px solid #aaa; }
    #hud {
      text-align:center; 
      margin-bottom:10px;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
    }
    #scoreRed, #scoreBlue {
      font-size:32px; font-weight:bold; padding:0 10px;
    }
    #scoreRed { color:red; }
    #scoreBlue { color:blue; }
    #gameStatus {
      font-size:22px; color:#333; margin-top:5px; min-height:28px;
    }
    #controls {
      text-align:center; 
      margin-top:10px; 
      font-size:20px; 
      color:#d2691e; 
      font-weight:bold;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background: #fffbe4;
      border-radius: 10px;
      padding: 6px 0;
      width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    #restartBtn {
      display: none;
      margin: 18px auto 0 auto;
      font-size: 24px;
      font-weight: bold;
      background: #ffecb3;
      color: #d2691e;
      border: 2px solid #d2691e;
      border-radius: 8px;
      padding: 10px 30px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #restartBtn:hover {
      background: #ffe4b5;
    }
  </style>
</head>
<body>
  <div id="hud">
    <span style="color:red; font-weight:bold;">æˆ‘æ–¹ï¼ˆç´…ï¼‰</span>
    <span id="scoreRed">0</span>
    <span style="font-size:28px;"> : </span>
    <span id="scoreBlue">0</span>
    <span style="color:blue; font-weight:bold;">æ•µæ–¹ï¼ˆè—ï¼‰</span>
    <div id="gameStatus"></div>
  </div>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <div id="controls">
    æ“ä½œèªªæ˜ï¼š<br>
    <span style="color:#0077cc;">â† â†’</span> å·¦å³ç§»å‹• &nbsp;|&nbsp; 
    <span style="color:#0077cc;">â†‘</span> æ‰˜çƒ &nbsp;|&nbsp; 
    <span style="color:#0077cc;">ç©ºç™½éµ</span> æ®ºçƒ/ç™¼çƒ &nbsp;|&nbsp; 
    <span style="color:#0077cc;">é€£æŒ‰å…©æ¬¡ â† æˆ– â†’</span> é£›æ’²æ•‘çƒ
  </div>
  <button id="restartBtn">å†ç©ä¸€æ¬¡</button>
  <script>
    // å ´åœ°èˆ‡è¦å‰‡åƒæ•¸
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const NET_X = W/2, NET_Y = H-120, NET_W = 8, NET_H = 120;
    const GROUND_Y = H-40;
    const PLAYER_SIZE = 32;
    const BALL_RADIUS = 12;
    const TEAM_SIZE = 3;
    const SCORE_TO_WIN = 3;
    const COURT_TOP = GROUND_Y-160, COURT_BOTTOM = GROUND_Y, COURT_LEFT = 0, COURT_RIGHT = W;

    // è§’è‰²èµ·å§‹ä½ç½®
    const positions = [
      [W/4, GROUND_Y-PLAYER_SIZE],      // ç©å®¶
      [W/4-60, GROUND_Y-PLAYER_SIZE],   // éšŠå‹1
      [W/4+60, GROUND_Y-PLAYER_SIZE],   // éšŠå‹2
      [W*3/4, GROUND_Y-PLAYER_SIZE],    // æ•µ1
      [W*3/4-60, GROUND_Y-PLAYER_SIZE], // æ•µ2
      [W*3/4+60, GROUND_Y-PLAYER_SIZE]  // æ•µ3
    ];

    // è§’è‰²ç‰©ä»¶
    let players, ball, score, servingTeam, gameOver, statusText, teamHits, lastHitter;
    let keys = {};
    let lastKey = null;
    let keyCount = 0;
    let lastKeyTime = 0;
    let animationId = null;

    function initGameVars() {
      players = [];
      for(let i=0;i<TEAM_SIZE*2;i++){
        players.push({
          x: positions[i][0], y: positions[i][1],
          vx: 0, vy: 0,
          color: i==0 ? 'red' : (i<TEAM_SIZE ? 'pink' : 'blue'),
          isPlayer: i==0, isAI: i!=0,
          jump: false, onGround: true,
          isSetting: false, isSpiking: false, isDiving: false, diveTimer: 0
        });
      }
      ball = {
        x: NET_X, y: GROUND_Y-120, vx: 0, vy: 0, lastTouch: null, lastTeam: null
      };
      score = [0,0];
      servingTeam = 0;
      gameOver = false;
      statusText = "";
      teamHits = [0,0];
      lastHitter = null;
      keys = {};
      lastKey = null;
      keyCount = 0;
      lastKeyTime = 0;
    }

    document.addEventListener('keydown', e=>{
      keys[e.key] = true;
      // é£›æ’²åµæ¸¬
      if(e.key === "ArrowLeft" || e.key === "ArrowRight") {
        let now = Date.now();
        if(lastKey === e.key && now - lastKeyTime < 300) {
          keyCount++;
        } else {
          keyCount = 1;
        }
        lastKey = e.key;
        lastKeyTime = now;
      }
    });
    document.addEventListener('keyup', e=>{
      keys[e.key] = false;
    });

    // ç™¼çƒ
    function serve(team){
      teamHits = [0,0];
      lastHitter = null;
      ball.lastTouch = null;
      ball.lastTeam = null;
      if(team==0){
        ball.x = players[0].x+20;
        ball.y = players[0].y-10;
        ball.vx = 0;
        ball.vy = 0;
        statusText = "è«‹æŒ‰ç©ºç™½éµç™¼çƒï¼";
      }else{
        ball.x = players[TEAM_SIZE].x-20;
        ball.y = players[TEAM_SIZE].y-10;
        ball.vx = 0;
        ball.vy = 0;
        statusText = "æ•µæ–¹ç™¼çƒä¸­...";
        setTimeout(()=>{
          ball.vx = -4;
          ball.vy = -5;
          statusText = "æ¯”è³½ä¸­";
        }, 900);
      }
      updateHud();
    }

    // åˆ¤å®šå¤±åˆ†
    function losePoint(team){
      score[1-team]++;
      statusText = (team === 0 ? "æ•µæ–¹å¾—åˆ†ï¼" : "æˆ‘æ–¹å¾—åˆ†ï¼");
      updateHud();
      if(score[0]>=SCORE_TO_WIN || score[1]>=SCORE_TO_WIN){
        gameOver = true;
        statusText = score[0]>score[1] ? "ğŸ‰ ä½ è´äº†ï¼" : "ğŸ˜¢ ä½ è¼¸äº†ï¼";
        updateHud();
        document.getElementById('restartBtn').style.display = "block";
        cancelAnimationFrame(animationId);
      }else{
        servingTeam = 1-team;
        setTimeout(()=>{ serve(servingTeam); }, 1200);
      }
    }

    // æ“Šçƒåˆ¤æ–·
    function onPlayerHit(playerIdx){
      let team = (playerIdx < TEAM_SIZE) ? 0 : 1;
      if(lastHitter === playerIdx){
        // åŒä¸€çƒå“¡é€£çºŒæ“Šçƒï¼ŒçŠ¯è¦
        losePoint(team);
        return false;
      }
      // è‹¥æ›éšŠï¼Œé‡ç½®æ“Šçƒæ¬¡æ•¸
      if(ball.lastTeam !== null && ball.lastTeam !== team){
        teamHits[team] = 0;
      }
      teamHits[team]++;
      lastHitter = playerIdx;
      ball.lastTeam = team;
      if(teamHits[team]>3){
        // å››æ¬¡æ“ŠçƒçŠ¯è¦
        losePoint(team);
        return false;
      }
      return true;
    }

    // ç¢°æ’æª¢æŸ¥
    function collideBall(p, idx){
      let dx = ball.x - (p.x+PLAYER_SIZE/2);
      let dy = ball.y - (p.y+PLAYER_SIZE/2);
      let dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < BALL_RADIUS+PLAYER_SIZE/2){
        if(!onPlayerHit(idx)) return; // è‹¥çŠ¯è¦å‰‡ç›´æ¥å¤±åˆ†
        // ç©å®¶å‹•ä½œæ±ºå®šçƒçš„åæ‡‰
        if(p.isPlayer) {
          // æ®ºçƒ
          if(p.isSpiking) {
            ball.vx = (ball.x < NET_X ? 1 : -1) * (8+Math.random()*2);
            ball.vy = -12 + Math.random()*2;
            statusText = "æ®ºçƒï¼";
          }
          // æ‰˜çƒ
          else if(p.isSetting) {
            ball.vx = (ball.x < NET_X ? 1 : -1) * (2+Math.random());
            ball.vy = -9 + Math.random()*1.5;
            statusText = "æ‰˜çƒï¼";
          }
          // é£›æ’²
          else if(p.isDiving) {
            ball.vx = (ball.x < NET_X ? 1 : -1) * (7+Math.random()*2);
            ball.vy = -6 + Math.random();
            statusText = "é£›æ’²æ•‘çƒï¼";
          }
          // ä¸€èˆ¬ç¢°æ’
          else {
            let angle = Math.atan2(dy, dx);
            ball.vx = Math.cos(angle)*(5+Math.random()*2);
            ball.vy = Math.sin(angle)*7 - 2;
            statusText = "ç¢°åˆ°çƒäº†ï¼";
          }
        } else {
          // AIç°¡å–®å‹•ä½œ
          // AIæœƒæ ¹æ“šæ“Šçƒæ¬¡æ•¸é¸æ“‡æ‰˜çƒæˆ–æ®ºçƒ
          if(teamHits[(idx<TEAM_SIZE)?0:1]===3){
            // ç¬¬ä¸‰æ¬¡æ“Šçƒï¼šæ®ºçƒ
            ball.vx = (p.x < NET_X ? 1 : -1) * (7+Math.random()*2);
            ball.vy = -11 + Math.random()*2;
          }else{
            // å¹³å¸¸ï¼šæ‰˜çƒ
            ball.vx = (p.x < NET_X ? 1 : -1) * (2+Math.random());
            ball.vy = -8 + Math.random()*2;
          }
        }
        ball.lastTouch = idx;
        updateHud();
      }
    }

    // AI æ§åˆ¶
    function aiMove(p, idx){
      let team = idx<TEAM_SIZE ? 0 : 1;
      let sideMin = team==0 ? COURT_LEFT : NET_X+NET_W/2;
      let sideMax = team==0 ? NET_X-NET_W/2-PLAYER_SIZE : COURT_RIGHT-PLAYER_SIZE;
      // åªè¿½çƒåœ¨è‡ªå·±åŠå ´
      if((team==0 && ball.x < NET_X) || (team==1 && ball.x > NET_X)){
        if(Math.abs((p.x+PLAYER_SIZE/2)-ball.x) > 10){
          if(ball.x < p.x+PLAYER_SIZE/2 && p.x > sideMin) p.vx = -2;
          else if(ball.x > p.x+PLAYER_SIZE/2 && p.x+PLAYER_SIZE < sideMax) p.vx = 2;
          else p.vx = 0;
        }else{
          p.vx = 0;
        }
        // è·³çƒ
        if(ball.y < p.y && Math.abs((p.x+PLAYER_SIZE/2)-ball.x)<30 && p.onGround){
          p.vy = -8;
          p.onGround = false;
        }
      }else{
        // å›åˆ°åŸä½
        let home = positions[idx][0];
        if(Math.abs(p.x-home)>5){
          p.vx = (home-p.x)/20;
        }else{
          p.vx = 0;
        }
      }
    }

    // ç©å®¶æ§åˆ¶
    function playerMove(p){
      // å·¦å³ç§»å‹•
      p.vx = 0;
      let left = COURT_LEFT, right = NET_X-NET_W/2-PLAYER_SIZE;
      if(keys["ArrowLeft"] && p.x>left) p.vx = -3;
      if(keys["ArrowRight"] && p.x+PLAYER_SIZE<right) p.vx = 3;

      // ä¸Šéµæ‰˜çƒ
      p.isSetting = !!keys["ArrowUp"];

      // ç©ºç™½éµæ®ºçƒæˆ–ç™¼çƒ
      p.isSpiking = !!keys[" "];

      // ç™¼çƒç‹€æ…‹
      if(servingTeam === 0 && ball.vx === 0 && ball.vy === 0 && p.isSpiking){
        ball.vx = 4;
        ball.vy = -6;
        statusText = "æ¯”è³½ä¸­";
        updateHud();
      }

      // é£›æ’²æ•‘çƒ
      if((keyCount >= 2) && (lastKey === "ArrowLeft" || lastKey === "ArrowRight") && p.onGround) {
        p.isDiving = true;
        p.diveTimer = 10; // é£›æ’²æŒçºŒæ™‚é–“
        p.vx = (lastKey === "ArrowLeft" ? -8 : 8);
        p.vy = -3;
        keyCount = 0;
      } else if(p.diveTimer > 0) {
        p.diveTimer--;
        if(p.diveTimer === 0) p.isDiving = false;
      } else {
        p.isDiving = false;
      }
    }

    // æ›´æ–°HUD
    function updateHud(){
      document.getElementById('scoreRed').textContent = score[0];
      document.getElementById('scoreBlue').textContent = score[1];
      let t = "";
      if(gameOver){
        t = score[0]>score[1] ? "ğŸ‰ ä½ è´äº†ï¼" : "ğŸ˜¢ ä½ è¼¸äº†ï¼";
      } else if(servingTeam === 0 && ball.vx === 0 && ball.vy === 0) {
        t = "æˆ‘æ–¹ç™¼çƒï¼Œè«‹æŒ‰ç©ºç™½éµç™¼çƒ";
      } else if(servingTeam === 1 && ball.vx === 0 && ball.vy === 0) {
        t = "æ•µæ–¹ç™¼çƒä¸­...";
      } else {
        t = statusText || "æ¯”è³½ä¸­";
      }
      if(!gameOver){
        t += `ã€€|ã€€${["æˆ‘æ–¹","æ•µæ–¹"][ball.lastTeam||0]}å·²æ“Šçƒæ¬¡æ•¸ï¼š${teamHits[ball.lastTeam||0]||0}`;
      }
      document.getElementById('gameStatus').textContent = t;
    }

    // æ›´æ–°éŠæˆ²
    function update(){
      if(gameOver) return;
      // ç©å®¶èˆ‡AIç§»å‹•
      for(let i=0;i<players.length;i++){
        let p = players[i];
        if(p.isPlayer) playerMove(p);
        else aiMove(p, i);
        // ç§»å‹•
        p.x += p.vx;
        // å ´åœ°é‚Šç•Œé™åˆ¶
        let left = i<TEAM_SIZE ? COURT_LEFT : NET_X+NET_W/2;
        let right = i<TEAM_SIZE ? NET_X-NET_W/2-PLAYER_SIZE : COURT_RIGHT-PLAYER_SIZE;
        if(p.x<left) p.x=left;
        if(p.x>right) p.x=right;
        // å‚ç›´é‚Šç•Œ
        if(p.y < COURT_TOP) p.y = COURT_TOP;
        if(p.y > GROUND_Y-PLAYER_SIZE){
          p.y = GROUND_Y-PLAYER_SIZE;
          p.vy = 0;
          p.onGround = true;
        } else {
          p.y += p.vy;
          if(!p.onGround) p.vy += 0.6; // é‡åŠ›
        }
      }

      // çƒç‰©ç†
      ball.x += ball.vx;
      ball.y += ball.vy;
      ball.vy += 0.4; // é‡åŠ›
      // ç©ºæ°£é˜»åŠ›
      ball.vx *= 0.995;
      // çƒèˆ‡åœ°é¢
      if(ball.y > GROUND_Y-BALL_RADIUS){
        ball.y = GROUND_Y-BALL_RADIUS;
        ball.vy *= -0.4;
        // çƒéœæ­¢æ™‚æ‰åˆ¤å®šå¤±åˆ†
        if(Math.abs(ball.vy)<2){
          // åˆ¤æ–·å¤±åˆ†
          let loseTeam = ball.x < NET_X ? 0 : 1;
          losePoint(loseTeam);
        }
        return;
      }
      // çƒèˆ‡å·¦å³ç‰†
      if(ball.x < BALL_RADIUS){ ball.x = BALL_RADIUS; ball.vx *= -0.7; }
      if(ball.x > W-BALL_RADIUS){ ball.x = W-BALL_RADIUS; ball.vx *= -0.7; }
      // çƒèˆ‡ç¶²
      if(ball.x > NET_X-NET_W/2-BALL_RADIUS && ball.x < NET_X+NET_W/2+BALL_RADIUS &&
         ball.y+BALL_RADIUS > NET_Y){
        // æ’åˆ°ç¶²å­
        if(ball.x < NET_X) ball.x = NET_X-NET_W/2-BALL_RADIUS;
        else ball.x = NET_X+NET_W/2+BALL_RADIUS;
        ball.vx *= -0.7;
      }
      // çƒèˆ‡è§’è‰²
      for(let i=0;i<players.length;i++){
        collideBall(players[i], i);
      }
      // çƒå‡ºé‚Šç·š
      if(ball.x < COURT_LEFT || ball.x > COURT_RIGHT){
        let loseTeam = ball.x < NET_X ? 0 : 1;
        losePoint(loseTeam);
        return;
      }
      // çƒå‡ºä¸Šç•Œ
      if(ball.y < COURT_TOP+BALL_RADIUS){
        ball.y = COURT_TOP+BALL_RADIUS;
        ball.vy *= -0.5;
      }
    }

    // ç•«é¢
    function draw(){
      ctx.clearRect(0,0,W,H);
      // æ²™ç˜
      ctx.fillStyle = "#ffe4b5";
      ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y);
      // å ´åœ°é‚Šç·š
      ctx.strokeStyle = "#d2691e";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(COURT_LEFT,GROUND_Y);
      ctx.lineTo(COURT_RIGHT,GROUND_Y);
      ctx.moveTo(COURT_LEFT,COURT_TOP);
      ctx.lineTo(COURT_RIGHT,COURT_TOP);
      ctx.moveTo(COURT_LEFT,GROUND_Y);
      ctx.lineTo(COURT_LEFT,COURT_TOP);
      ctx.moveTo(COURT_RIGHT,GROUND_Y);
      ctx.lineTo(COURT_RIGHT,COURT_TOP);
      ctx.stroke();
      // ç¶²å­
      ctx.fillStyle = "#fff";
      ctx.fillRect(NET_X-NET_W/2, NET_Y, NET_W, NET_H);
      // è§’è‰²
      for(let i=0;i<players.length;i++){
        let p = players[i];
        ctx.beginPath();
        ctx.arc(p.x+PLAYER_SIZE/2, p.y+PLAYER_SIZE/2, PLAYER_SIZE/2, 0, 2*Math.PI);
        ctx.fillStyle = p.color;
        ctx.fill();
        ctx.strokeStyle = "#333";
        ctx.stroke();
        // é£›æ’²ç‰¹æ•ˆ
        if(p.isDiving) {
          ctx.save();
          ctx.globalAlpha = 0.5;
          ctx.fillStyle = "#888";
          ctx.fillRect(p.x, p.y+PLAYER_SIZE, PLAYER_SIZE, 8);
          ctx.restore();
        }
      }
      // çƒ
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, 2*Math.PI);
      ctx.fillStyle = "#fff200";
      ctx.fill();
      ctx.strokeStyle = "#333";
      ctx.stroke();
    }

    // éŠæˆ²ä¸»å¾ªç’°
    function loop(){
      update();
      draw();
      animationId = requestAnimationFrame(loop);
    }

    // é‡ç©
    document.getElementById('restartBtn').onclick = function(){
      this.style.display = "none";
      initGameVars();
      serve(servingTeam);
      updateHud();
      loop();
    };

    // åˆå§‹å•Ÿå‹•
    initGameVars();
    serve(servingTeam);
    updateHud();
    loop();
  </script>
</body>
</html>
